<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moonlight Densetsu Lyrics - Interactive</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=Prata:wght@400&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Cinzel:wght@400;500;600&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --controls-bg: #4a5568;
            --controls-hover: #718096;
            --controls-active: #f6e05e;
            --text-light: #f0f2f5;
            --text-dark: #1a202c;
            --text-muted: #a0aec0;
            --bg-dark-translucent: rgba(26, 32, 44, 0.50);
            --border-color: #4a5568;
            
            /* Font combinations */
            --body-font: 'Lora', serif;
            --display-font: 'Prata', serif;
            --display-weight: 400;
            --display-spacing: 0.5px;
        }

        body {
            font-family: var(--body-font);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            color: var(--text-light);
            background-color: var(--text-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
        }

        #bg-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.50);
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            padding: 20px;
            background-color: var(--bg-dark-translucent);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            scroll-padding-bottom: 40vh;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .container.minimized {
            display: none;
        }

        .container::-webkit-scrollbar {
            display: none;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            transition: opacity 0.3s ease-out;
            position: relative;
            z-index: 100;
        }

        .font-switcher {
            position: absolute;
            top: -45px;
            right: 0;
            background-color: rgba(26, 32, 44, 0.9);
            border-radius: 20px;
            padding: 8px 12px;
            font-size: 0.8em;
            color: var(--text-muted);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            cursor: pointer;
            user-select: none;
        }

        .font-switcher:hover {
            background-color: rgba(26, 32, 44, 0.95);
            color: var(--text-light);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Transitions only for non-Fire TV devices */
        @media (pointer: fine) {
            .font-switcher {
                transition: all 0.2s ease;
            }
        }

        .minimized-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            margin-bottom: 0;
            background-color: rgba(26, 32, 44, 0.9);
            padding: 15px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .controls.minimized {
            position: fixed;
            top: 20px;
            right: 20px;
            transform: none;
            margin-top: 0;
            margin-bottom: 0;
            background-color: rgba(26, 32, 44, 0.9);
            padding: 15px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-btn {
            background-color: var(--controls-bg);
            color: var(--text-light);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            z-index: 101;
            position: relative;
        }

        .control-btn:focus {
            outline: 3px solid var(--controls-active);
            outline-offset: 2px;
            background-color: var(--controls-hover);
        }

        .control-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .control-btn:hover {
            background-color: var(--controls-hover);
            transform: scale(1.1);
        }

        .control-btn.active {
            background-color: var(--controls-active);
            color: var(--text-dark);
        }

        h1 {
            text-align: center;
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 2.5em;
            font-weight: var(--display-weight);
            font-family: var(--display-font);
            width: 100%;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: var(--display-spacing);
        }

        .lyrics-grid {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .lyrics-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0 40px;
            padding: 0 10px;
            margin-bottom: 15px;
        }

        .grid-header {
            color: var(--text-muted);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 0;
            font-size: 1.8em;
            font-weight: var(--display-weight);
            font-family: var(--display-font);
            letter-spacing: calc(var(--display-spacing) * 0.6);
        }

        .lyric-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0 40px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease-in-out;
            align-items: baseline;
        }

        .japanese-line,
        .translation-line {
            margin: 0;
            padding: 0;
            transition: color 0.3s ease-in-out;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }

        .japanese-line {
            font-size: 1.2em;
            line-height: 1.4;
        }

        .word-tooltip {
            position: relative;
            display: inline-block;
            padding: 2px 0;
            border-radius: 3px;
            margin: 0 1px;
            -webkit-tap-highlight-color: transparent;
        }

        .word-group {
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        .translation-phrase {
            border-radius: 4px;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        rt {
            font-size: 0.5em;
            color: #cbd5e0;
            user-select: none;
            transition: color 0.3s ease-in-out;
        }

        h1 rt {
            font-size: 0.4em;
        }

        .tooltip-box {
            position: absolute;
            background-color: #2d3748;
            color: #f7fafc;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85em;
            white-space: normal;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            min-width: 200px;
            max-width: 300px;
            text-align: left;
            line-height: 1.4;
            pointer-events: none;
            border: 1px solid var(--border-color);
        }

        .tooltip-box h4 {
            margin-top: 0;
            margin-bottom: 5px;
            color: #f6e05e;
            font-size: 1.1em;
        }

        .tooltip-box h4 .kanji-color {
            color: #68d391;
        }

        .tooltip-box p {
            margin: 0;
            padding: 2px 0;
        }

        .tooltip-box strong {
            color: #9ae6b4;
        }

        .tooltip-box .kana-romaji {
            font-size: 0.9em;
            color: var(--text-muted);
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid var(--border-color);
        }

        .tooltip-box .kana-display {
            color: #e2e8f0;
        }

        .tooltip-box .lyric-note {
            font-style: italic;
            color: #f6ad55;
            margin-top: 8px;
            font-size: 0.85em;
        }

        .translation-line {
            font-size: 1em;
            font-weight: 600;
            color: #e2e8f0;
        }

        .highlight-jp-group,
        .highlight-en-phrase {
            background-color: rgba(173, 216, 230, 0.7);
            color: var(--text-dark);
        }

        .lyric-row.highlight-line {
            background-color: rgba(246, 224, 94, 0.6);
        }

        .lyric-row.highlight-line .japanese-line,
        .lyric-row.highlight-line .translation-line {
            color: var(--text-dark);
        }

        .lyric-row.highlight-line rt {
            color: #2d3748;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                max-height: calc(100vh - 20px);
            }

            h1 {
                font-size: 2em;
                margin-bottom: 20px;
            }

            .lyrics-header {
                display: none;
            }

            .lyric-row {
                grid-template-columns: 1fr;
                gap: 5px 0;
                align-items: start;
            }

            .grid-header {
                font-size: 1.5em;
                margin-bottom: 10px;
            }

            .japanese-line {
                font-size: 1.2em;
            }

            .translation-line {
                font-size: 0.9em;
                color: var(--text-muted);
            }
        }

        /* Fire TV optimizations */
        @media (pointer: coarse) {
            * {
                transform: none !important;
                transform-style: flat !important;
                transition: none !important;
                animation: none !important;
            }
            
            .container {
                transform: none !important;
                transition: none !important;
            }
            
            .container.minimized {
                display: none !important;
            }
            
            .control-btn:hover {
                transform: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="video-background">
        <video id="bg-video" src="moonlight-densetsu.mp4" playsinline></video>
    </div>
    <div class="video-overlay"></div>

    <!-- Controls when minimized (top-right corner) -->
    <div class="controls minimized-controls" style="display: none;">
        <button id="play-pause-btn-mini" class="control-btn" tabindex="0" aria-label="Play/Pause"></button>
        <button id="loop-btn-mini" class="control-btn" tabindex="0" aria-label="Toggle Loop"></button>
        <button id="mute-btn-mini" class="control-btn" tabindex="0" aria-label="Mute/Unmute"></button>
        <button id="scroll-lock-btn-mini" class="control-btn active" tabindex="0" aria-label="Toggle Scroll Lock"></button>
        <button id="lyrics-toggle-btn-mini" class="control-btn active" tabindex="0" aria-label="Toggle Lyrics"></button>
    </div>

    <div class="container">
        <h1>
            „É†„Éº„É≥„É©„Ç§„Éà<ruby>‰ºùË™¨<rt>„Åß„Çì„Åõ„Å§</rt></ruby>
            <br>
            <span style="font-size: 0.6em; font-weight: 400;">(Moonlight Densetsu)</span>
        </h1>

        <div class="controls main-controls">
            <div class="font-switcher" id="font-switcher">‚ú® Romantic</div>
            <button id="play-pause-btn" class="control-btn" tabindex="0" aria-label="Play/Pause"></button>
            <button id="loop-btn" class="control-btn" tabindex="0" aria-label="Toggle Loop"></button>
            <button id="mute-btn" class="control-btn" tabindex="0" aria-label="Mute/Unmute"></button>
            <button id="scroll-lock-btn" class="control-btn active" tabindex="0" aria-label="Toggle Scroll Lock"></button>
            <button id="lyrics-toggle-btn" class="control-btn active" tabindex="0" aria-label="Toggle Lyrics"></button>
        </div>

        <div id="lyrics-body" class="lyrics-grid">
            <div class="lyrics-header">
                <h2 class="grid-header">Japanese</h2>
                <h2 class="grid-header">English</h2>
            </div>
            <div class="lyric-row" data-start-time="27.740" data-end-time="31.480">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="1-1"><span class="word-tooltip" data-meaning="sorry" data-grammar="Interjection" data-kana="„Åî„ÇÅ„Çì„Å≠" data-romaji="gomen ne">„Åî„ÇÅ„Çì„Å≠</span></span>
                    <span class="word-group" data-group-id="1-2"><span class="word-tooltip" data-kanji="Á¥†Áõ¥" data-meaning="honest, frank" data-grammar="„Å™-adjective, Noun" data-kana="„Åô„Å™„Åä" data-romaji="sunao"><ruby>Á¥†Áõ¥<rt>„Åô„Å™„Åä</rt></ruby></span></span>
                    <span class="word-group" data-group-id="1-3"><span class="word-tooltip" data-meaning="is not" data-grammar="Conjugation of „Å† (copula)" data-kana="„Åò„ÇÉ„Å™„Åè„Å¶" data-romaji="ja nakute">„Åò„ÇÉ„Å™„Åè„Å¶</span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="1-1">I'm sorry</span>
                    <span class="translation-phrase" data-group-id="1-3">I'm not</span>
                    <span class="translation-phrase" data-group-id="1-2">honest,</span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="31.480" data-end-time="34.820">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="2-1"><span class="word-tooltip" data-kanji="Â§¢" data-meaning="dream" data-grammar="Noun" data-kana="„ÇÜ„ÇÅ" data-romaji="yume"><ruby>Â§¢<rt>„ÇÜ„ÇÅ</rt></ruby></span></span>
                    <span class="word-group" data-group-id="2-2"><span class="word-tooltip" data-kanji="‰∏≠" data-meaning="inside, in" data-grammar="Noun" data-kana="„ÅÆ„Å™„Åã" data-romaji="no naka">„ÅÆ<ruby>‰∏≠<rt>„Å™„Åã</rt></ruby></span></span>
                    <span class="word-group" data-group-id="2-3"><span class="word-tooltip" data-meaning="if it is" data-grammar="Conditional particle" data-kana="„Å™„Çâ" data-romaji="nara">„Å™„Çâ</span></span>
                    <span class="word-group" data-group-id="2-4"><span class="word-tooltip" data-kanji="Ë®Ä„Åà„Çã" data-meaning="can say" data-grammar="Ichidan verb, Potential form" data-kana="„ÅÑ„Åà„Çã" data-romaji="ieru"><ruby>Ë®Ä<rt>„ÅÑ</rt></ruby>„Åà„Çã</span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="2-3">But</span>
                    <span class="translation-phrase" data-group-id="2-2">in my</span>
                    <span class="translation-phrase" data-group-id="2-1">dreams,</span>
                    <span class="translation-phrase" data-group-id="2-4">I can tell you.</span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="34.820" data-end-time="38.300">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="3-1"><span class="word-tooltip" data-kanji="ÊÄùËÄÉ" data-meaning="thought" data-grammar="Noun" data-kana="„Åó„Åì„ÅÜ" data-romaji="shikou"><ruby>ÊÄùËÄÉ<rt>„Åó„Åì„ÅÜ</rt></ruby></span></span>
                    <span class="word-group" data-group-id="3-2"><span class="word-tooltip" data-kanji="ÂõûË∑Ø" data-meaning="circuit" data-grammar="Noun" data-kana="„Åã„ÅÑ„Çç" data-romaji="kairo"><ruby>ÂõûË∑Ø<rt>„Åã„ÅÑ„Çç</rt></ruby></span>„ÅØ</span>
                    <span class="word-group" data-group-id="3-3"><span class="word-tooltip" data-meaning="short (circuit)" data-grammar="Noun, Katakana loanword" data-kana="„Ç∑„Éß„Éº„Éà" data-romaji="shouto">„Ç∑„Éß„Éº„Éà</span></span>
                    <span class="word-group" data-group-id="3-4"><span class="word-tooltip" data-kanji="ÂØ∏Ââç" data-meaning="on the verge of" data-grammar="Noun" data-kana="„Åô„Çì„Åú„Çì" data-romaji="sunzen"><ruby>ÂØ∏Ââç<rt>„Åô„Çì„Åú„Çì</rt></ruby></span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="3-1">My thought</span>
                    <span class="translation-phrase" data-group-id="3-2">circuits are</span>
                    <span class="translation-phrase" data-group-id="3-4">on the verge of</span>
                    <span class="translation-phrase" data-group-id="3-3">shorting out;</span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="38.300" data-end-time="41.480">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="4-1"><span class="word-tooltip" data-kanji="‰ªä„Åô„Åê" data-meaning="immediately" data-grammar="Adverb" data-kana="„ÅÑ„Åæ„Åô„Åê" data-romaji="ima sugu"><ruby>‰ªä<rt>„ÅÑ„Åæ</rt></ruby>„Åô„Åê</span></span>
                    <span class="word-group" data-group-id="4-2"><span class="word-tooltip" data-kanji="‰ºö„ÅÑ„Åü„ÅÑ" data-meaning="want to meet" data-grammar="„ÅÑ-adjective, „Åü„ÅÑ form" data-kana="„ÅÇ„ÅÑ„Åü„ÅÑ" data-romaji="aitai"><ruby>‰ºö<rt>„ÅÇ</rt></ruby>„ÅÑ„Åü„ÅÑ</span></span>
                    <span class="word-group" data-group-id="4-3"><span class="word-tooltip" data-meaning="emphasis" data-grammar="Particle" data-kana="„Çà" data-romaji="yo">„Çà</span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="4-2">I want to see you</span>
                    <span class="translation-phrase" data-group-id="4-1">right now.</span>
                    <span class="translation-phrase" data-group-id="4-3"></span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="41.480" data-end-time="45.220">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="5-1"><span class="word-tooltip" data-meaning="makes one want to cry" data-grammar="Phrase" data-kana="„Å™„Åç„Åü„Åè„Å™„Çã„Çà„ÅÜ„Å™" data-romaji="nakitaku naru you na"><ruby>Ê≥£<rt>„Å™</rt></ruby>„Åç„Åü„Åè„Å™„Çã„Çà„ÅÜ„Å™</span></span>
                    <span class="word-group" data-group-id="5-2"><span class="word-tooltip" data-meaning="moonlight" data-grammar="Noun, Katakana loanword" data-kana="„É†„Éº„É≥„É©„Ç§„Éà" data-romaji="muunraito">„É†„Éº„É≥„É©„Ç§„Éà</span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="5-2">This moonlight</span>
                    <span class="translation-phrase" data-group-id="5-1">makes me want to cry,</span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="45.220" data-end-time="48.620">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="6-1"><span class="word-tooltip" data-kanji="ÈõªË©±" data-meaning="call" data-grammar="Noun" data-kana="„Åß„Çì„Çè" data-romaji="denwa"><ruby>ÈõªË©±<rt>„Åß„Çì„Çè</rt></ruby></span></span>
                    <span class="word-group" data-group-id="6-2"><span class="word-tooltip" data-meaning="even" data-grammar="Particle" data-kana="„ÇÇ" data-romaji="mo">„ÇÇ</span></span>
                    <span class="word-group" data-group-id="6-3"><span class="word-tooltip" data-meaning="cannot do" data-grammar="Ichidan verb, Potential negative" data-kana="„Åß„Åç„Å™„ÅÑ" data-romaji="dekinai">„Åß„Åç„Å™„ÅÑ</span></span>
                    <span class="word-group" data-group-id="6-4"><span class="word-tooltip" data-meaning="midnight" data-grammar="Noun, Katakana loanword" data-kana="„Éü„ÉÉ„Éâ„Éä„Ç§„Éà" data-romaji="middonaito">„Éü„ÉÉ„Éâ„Éä„Ç§„Éà</span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="6-4">It's midnight and</span>
                    <span class="translation-phrase" data-group-id="6-3">I can't</span>
                    <span class="translation-phrase" data-group-id="6-2">even</span>
                    <span class="translation-phrase" data-group-id="6-1">call.</span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="48.620" data-end-time="51.720">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="7-1"><span class="word-tooltip" data-meaning="but, because" data-grammar="Conjunction" data-kana="„Å†„Å£„Å¶" data-romaji="datte">„Å†„Å£„Å¶</span></span>
                    <span class="word-group" data-group-id="7-2"><span class="word-tooltip" data-kanji="Á¥îÊÉÖ" data-meaning="pure heart, innocence" data-grammar="Noun" data-kana="„Åò„ÇÖ„Çì„Åò„Çá„ÅÜ" data-romaji="junjou"><ruby>Á¥îÊÉÖ<rt>„Åò„ÇÖ„Çì„Åò„Çá„ÅÜ</rt></ruby></span></span>
                    <span class="word-group" data-group-id="7-3"><span class="word-tooltip" data-meaning="what should I do?" data-grammar="Phrase" data-kana="„Å©„ÅÜ„Åó„Çà„ÅÜ" data-romaji="dou shiyou">„Å©„ÅÜ„Åó„Çà„ÅÜ</span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="7-1">But</span>
                    <span class="translation-phrase" data-group-id="7-3">what should I do</span>
                    <span class="translation-phrase" data-group-id="7-2">with these pure feelings?</span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="51.720" data-end-time="54.820">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="8-1"><span class="word-tooltip" data-meaning="heart" data-grammar="Noun, Katakana loanword" data-kana="„Éè„Éº„Éà" data-romaji="haato">„Éè„Éº„Éà</span>„ÅØ</span>
                    <span class="word-group" data-group-id="8-2"><span class="word-tooltip" data-kanji="‰∏áËèØÈè°" data-meaning="kaleidoscope" data-grammar="Noun" data-kana="„Åæ„Çì„Åí„Åç„Çá„ÅÜ" data-romaji="mangekyou"><ruby>‰∏áËèØÈè°<rt>„Åæ„Çì„Åí„Åç„Çá„ÅÜ</rt></ruby></span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="8-1">My heart</span>
                    <span class="translation-phrase" data-group-id="8-2">is a kaleidoscope.</span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="55.820" data-end-time="62.520">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="9-1"><span class="word-tooltip" data-kanji="Êúà" data-meaning="moon" data-grammar="Noun" data-kana="„Å§„Åç" data-romaji="tsuki"><ruby>Êúà<rt>„Å§„Åç</rt></ruby></span></span>
                    <span class="word-group" data-group-id="9-2"><span class="word-tooltip" data-meaning="'s" data-grammar="Particle" data-kana="„ÅÆ" data-romaji="no">„ÅÆ</span></span>
                    <span class="word-group" data-group-id="9-3"><span class="word-tooltip" data-kanji="ÂÖâ" data-meaning="light" data-grammar="Noun" data-kana="„Å≤„Åã„Çä" data-romaji="hikari"><ruby>ÂÖâ<rt>„Å≤„Åã„Çä</rt></ruby></span></span>
                    <span class="word-group" data-group-id="9-4"><span class="word-tooltip" data-meaning="by, in" data-grammar="Particle" data-kana="„Å´" data-romaji="ni">„Å´</span></span>
                    <span class="word-group" data-group-id="9-5"><span class="word-tooltip" data-kanji="Â∞é„Åã„Çå" data-meaning="guided, led" data-grammar="Godan verb, Passive form" data-kana="„Åø„Å°„Å≥„Åã„Çå" data-romaji="michibikare"><ruby>Â∞é<rt>„Åø„Å°„Å≥</rt></ruby>„Åã„Çå</span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="9-5">Guided</span>
                    <span class="translation-phrase" data-group-id="9-4">by</span>
                    <span class="translation-phrase" data-group-id="9-1">the moon</span>
                    <span class="translation-phrase" data-group-id="9-2">'s</span>
                    <span class="translation-phrase" data-group-id="9-3">light,</span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="62.520" data-end-time="68.220">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="10-1"><span class="word-tooltip" data-kanji="‰ΩïÂ∫¶" data-meaning="many times" data-grammar="Adverb" data-kana="„Å™„Çì„Å©" data-romaji="nando mo"><ruby>‰ΩïÂ∫¶<rt>„Å™„Çì„Å©</rt></ruby>„ÇÇ</span></span>
                    <span class="word-group" data-group-id="10-2"><span class="word-tooltip" data-kanji="Â∑°„Çä‰ºö„ÅÜ" data-meaning="to meet by chance, be reunited" data-grammar="Compound Verb" data-kana="„ÇÅ„Åê„Çä„ÅÇ„ÅÜ" data-romaji="meguriau" data-lyric-note="Â∑°„Çä (from Â∑°„Çã 'to go around') + ‰ºö„ÅÜ ('to meet'). Functions as a single word."><ruby>Â∑°<rt>„ÇÅ„Åê</rt></ruby>„Çä<ruby>‰ºö<rt>„ÅÇ</rt></ruby>„ÅÜ</span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="10-2">We meet</span>
                    <span class="translation-phrase" data-group-id="10-1">again and again.</span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="69.220" data-end-time="72.720">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="11-1"><span class="word-tooltip" data-kanji="ÊòüÂ∫ß" data-meaning="constellation" data-grammar="Noun" data-kana="„Åõ„ÅÑ„Åñ" data-romaji="seiza"><ruby>ÊòüÂ∫ß<rt>„Åõ„ÅÑ„Åñ</rt></ruby></span></span>
                    <span class="word-group" data-group-id="11-2"><span class="word-tooltip" data-meaning="of the" data-grammar="Particle" data-kana="„ÅÆ" data-romaji="no">„ÅÆ</span></span>
                    <span class="word-group" data-group-id="11-3"><span class="word-tooltip" data-kanji="Áû¨„Åç" data-meaning="twinkling" data-grammar="Noun" data-kana="„Åæ„Åü„Åü„Åç" data-romaji="matataki"><ruby>Áû¨<rt>„Åæ„Åü„Åü</rt></ruby>„Åç</span></span>
                    <span class="word-group" data-group-id="11-4"><span class="word-tooltip" data-kanji="Êï∞„Åà" data-meaning="to count" data-grammar="Godan verb, stem form" data-kana="„Åã„Åû„Åà" data-romaji="kazoe"><ruby>Êï∞<rt>„Åã„Åû</rt></ruby>„Åà</span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="11-4">Counting</span>
                    <span class="translation-phrase" data-group-id="11-3">the twinkling</span>
                    <span class="translation-phrase" data-group-id="11-2">of the</span>
                    <span class="translation-phrase" data-group-id="11-1">constellations,</span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="72.720" data-end-time="76.220">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="12-1"><span class="word-tooltip" data-kanji="Âç†„ÅÜ" data-meaning="to foretell" data-grammar="Godan verb" data-kana="„ÅÜ„Çâ„Å™„ÅÜ" data-romaji="uranau"><ruby>Âç†<rt>„ÅÜ„Çâ„Å™</rt></ruby>„ÅÜ</span></span>
                    <span class="word-group" data-group-id="12-2"><span class="word-tooltip" data-kanji="ÊÅã" data-meaning="love" data-grammar="Noun" data-kana="„Åì„ÅÑ" data-romaji="koi"><ruby>ÊÅã<rt>„Åì„ÅÑ</rt></ruby></span></span>
                    <span class="word-group" data-group-id="12-3"><span class="word-tooltip" data-meaning="of" data-grammar="Particle" data-kana="„ÅÆ" data-romaji="no">„ÅÆ</span></span>
                    <span class="word-group" data-group-id="12-4"><span class="word-tooltip" data-kanji="Ë°åÊñπ" data-meaning="outcome" data-grammar="Noun" data-kana="„ÇÜ„Åè„Åà" data-romaji="yukue"><ruby>Ë°åÊñπ<rt>„ÇÜ„Åè„Åà</rt></ruby></span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="12-1">I foretell</span>
                    <span class="translation-phrase" data-group-id="12-4">the outcome</span>
                    <span class="translation-phrase" data-group-id="12-3">of our</span>
                    <span class="translation-phrase" data-group-id="12-2">love.</span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="76.220" data-end-time="79.720">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="13-1"><span class="word-tooltip" data-kanji="Âêå„Åò" data-meaning="same" data-grammar="„Å™-adjective, Noun" data-kana="„Åä„Å™„Åò" data-romaji="onaji"><ruby>Âêå<rt>„Åä„Å™</rt></ruby>„Åò</span></span>
                    <span class="word-group" data-group-id="13-2"><span class="word-tooltip" data-kanji="Âú∞ÁêÉ" data-meaning="Earth (planet)" data-grammar="Noun" data-kana="„Åè„Å´" data-romaji="kuni" data-lyric-note="Kanji is Âú∞ÁêÉ (chiky≈´ - Earth), but sung as 'kuni' („Åè„Å´ - country)."><ruby>Âú∞ÁêÉ<rt>„Åè„Å´</rt></ruby></span></span>
                    <span class="word-group" data-group-id="13-3"><span class="word-tooltip" data-meaning="on" data-grammar="Particle" data-kana="„Å´" data-romaji="ni">„Å´</span></span>
                    <span class="word-group" data-group-id="13-4"><span class="word-tooltip" data-kanji="Áîü„Åæ„Çå„Åü" data-meaning="born" data-grammar="Ichidan verb, Past tense" data-kana="„ÅÜ„Åæ„Çå„Åü" data-romaji="umareta"><ruby>Áîü<rt>„ÅÜ</rt></ruby>„Åæ„Çå„Åü</span></span>
                    <span class="word-group" data-group-id="13-5"><span class="word-tooltip" data-meaning="softening particle" data-grammar="Particle" data-kana="„ÅÆ" data-romaji="no">„ÅÆ</span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="13-4">We were born</span>
                    <span class="translation-phrase" data-group-id="13-3">on the</span>
                    <span class="translation-phrase" data-group-id="13-1">same</span>
                    <span class="translation-phrase" data-group-id="13-2">Earth‚Äî</span>
                    <span class="translation-phrase" data-group-id="13-5"></span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="79.720" data-end-time="82.720">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="14-1"><span class="word-tooltip" data-meaning="miracle" data-grammar="Noun, Katakana loanword" data-kana="„Éü„É©„ÇØ„É´" data-romaji="mirakuru">„Éü„É©„ÇØ„É´</span></span>
                    <span class="word-group" data-group-id="14-2"><span class="word-tooltip" data-meaning="romance" data-grammar="Noun, Katakana loanword" data-kana="„É≠„Éû„É≥„Çπ" data-romaji="romansu">„É≠„Éû„É≥„Çπ</span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="14-1">A miracle</span>
                    <span class="translation-phrase" data-group-id="14-2">romance.</span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="83.220" data-end-time="86.220">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="15-1"><span class="word-tooltip" data-kanji="‰ø°„Åò„Å¶" data-meaning="believing" data-grammar="Ichidan verb, Te-form" data-kana="„Åó„Çì„Åò„Å¶" data-romaji="shinjite"><ruby>‰ø°<rt>„Åó„Çì</rt></ruby>„Åò„Å¶</span></span>
                    <span class="word-group" data-group-id="15-2"><span class="word-tooltip" data-meaning="am/is/are (continuous state)" data-grammar="Verb + Particle" data-kana="„ÅÑ„Çã„ÅÆ" data-romaji="iru no">„ÅÑ„Çã„ÅÆ</span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="15-1">Believing,</span>
                    <span class="translation-phrase" data-group-id="15-2"></span>
                </p>
            </div>
            <div class="lyric-row" data-start-time="86.220" data-end-time="89.220">
                <p class="japanese-line">
                    <span class="word-group" data-group-id="16-1"><span class="word-tooltip" data-meaning="miracle" data-grammar="Noun, Katakana loanword" data-kana="„Éü„É©„ÇØ„É´" data-romaji="mirakuru">„Éü„É©„ÇØ„É´</span></span>
                    <span class="word-group" data-group-id="16-2"><span class="word-tooltip" data-meaning="romance" data-grammar="Noun, Katakana loanword" data-kana="„É≠„Éû„É≥„Çπ" data-romaji="romansu">„É≠„Éû„É≥„Çπ</span></span>
                </p>
                <p class="translation-line">
                    <span class="translation-phrase" data-group-id="16-1">A miracle</span>
                    <span class="translation-phrase" data-group-id="16-2">romance.</span>
                </p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('bg-video');
            
            // Main controls (inside container)
            const playPauseBtn = document.getElementById('play-pause-btn');
            const loopBtn = document.getElementById('loop-btn');
            const muteBtn = document.getElementById('mute-btn');
            const scrollLockBtn = document.getElementById('scroll-lock-btn');
            const lyricsToggleBtn = document.getElementById('lyrics-toggle-btn');
            const fontSwitcher = document.getElementById('font-switcher');
            
            // Mini controls (top-right when minimized)
            const playPauseBtnMini = document.getElementById('play-pause-btn-mini');
            const loopBtnMini = document.getElementById('loop-btn-mini');
            const muteBtnMini = document.getElementById('mute-btn-mini');
            const scrollLockBtnMini = document.getElementById('scroll-lock-btn-mini');
            const lyricsToggleBtnMini = document.getElementById('lyrics-toggle-btn-mini');
            
            const container = document.querySelector('.container');
            const mainControls = document.querySelector('.main-controls');
            const miniControls = document.querySelector('.minimized-controls');
            const lyricRows = document.querySelectorAll('.lyric-row');
            const tooltips = document.querySelectorAll('.word-tooltip');
            let currentTooltipElement = null;

            // Font combinations
            const fontCombos = [
                {
                    name: '‚ú® Romantic',
                    body: "'Lora', serif",
                    display: "'Prata', serif",
                    weight: '400',
                    spacing: '0.5px'
                },
                {
                    name: 'üåô Classical',
                    body: "'Crimson Text', serif",
                    display: "'Cinzel', serif",
                    weight: '600',
                    spacing: '1px'
                },
                {
                    name: 'üí´ Elegant',
                    body: "'Cormorant Garamond', serif",
                    display: "'Playfair Display', serif",
                    weight: '500',
                    spacing: '0.8px'
                }
            ];
            
            let currentFontIndex = 0;

            function switchFont() {
                currentFontIndex = (currentFontIndex + 1) % fontCombos.length;
                const combo = fontCombos[currentFontIndex];
                
                document.documentElement.style.setProperty('--body-font', combo.body);
                document.documentElement.style.setProperty('--display-font', combo.display);
                document.documentElement.style.setProperty('--display-weight', combo.weight);
                document.documentElement.style.setProperty('--display-spacing', combo.spacing);
                
                fontSwitcher.textContent = combo.name;
            }

            fontSwitcher.addEventListener('click', switchFont);
            fontSwitcher.addEventListener('keydown', (e) => {
                if (e.code === 'Enter' || e.code === 'Space') {
                    e.preventDefault();
                    switchFont();
                }
            });

            const icons = {
                play: `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`,
                pause: `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`,
                loop: `<svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>`,
                volumeOn: `<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`,
                volumeOff: `<svg viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>`,
                scrollFollow: `<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15l-5-5h3V9h4v3h3l-5 5z"/></svg>`,
                scrollLocked: `<svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>`,
                lyricsShow: `<svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`,
                lyricsHide: `<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5h3V9h4v3h3l-5 5z"/></svg>`
            };
            
            let currentRowIndex = -1;
            let isScrollFollowing = true;
            let lyricsVisible = true;

            function togglePlayPause() {
                if (video.paused) {
                    video.play();
                    // This block ensures the video unmutes on play
                    if (video.muted) {
                        video.muted = false;
                        updateMuteIcon();
                    }
                } else {
                    video.pause();
                }
            }

            function updatePlayPauseIcon() {
                const icon = video.paused ? icons.play : icons.pause;
                playPauseBtn.innerHTML = icon;
                playPauseBtnMini.innerHTML = icon;
            }

            function updateMuteIcon() {
                const icon = video.muted ? icons.volumeOff : icons.volumeOn;
                muteBtn.innerHTML = icon;
                muteBtnMini.innerHTML = icon;
                muteBtn.classList.toggle('active', !video.muted);
                muteBtnMini.classList.toggle('active', !video.muted);
            }
            
            function updateScrollLockIcon() {
                const icon = isScrollFollowing ? icons.scrollFollow : icons.scrollLocked;
                scrollLockBtn.innerHTML = icon;
                scrollLockBtnMini.innerHTML = icon;
                scrollLockBtn.classList.toggle('active', isScrollFollowing);
                scrollLockBtnMini.classList.toggle('active', isScrollFollowing);
            }

            function updateLyricsToggleIcon() {
                const icon = lyricsVisible ? icons.lyricsShow : icons.lyricsHide;
                lyricsToggleBtn.innerHTML = icon;
                lyricsToggleBtnMini.innerHTML = icon;
                lyricsToggleBtn.classList.toggle('active', lyricsVisible);
                lyricsToggleBtnMini.classList.toggle('active', lyricsVisible);
            }

            function toggleLyrics() {
                lyricsVisible = !lyricsVisible;
                container.classList.toggle('minimized', !lyricsVisible);
                
                if (lyricsVisible) {
                    mainControls.style.display = 'flex';
                    miniControls.style.display = 'none';
                } else {
                    mainControls.style.display = 'none';
                    miniControls.style.display = 'flex';
                }
                
                updateLyricsToggleIcon();
            }

            function updateTime() {
                // Throttle updates for Fire TV performance
                const currentTime = video.currentTime;
                const minutes = Math.floor(currentTime / 60);
                const seconds = String(Math.floor(currentTime % 60)).padStart(2, '0');
                document.title = `(${minutes}:${seconds}) - Moonlight Densetsu`;
                
                let activeRow = null;

                lyricRows.forEach((row, index) => {
                    const startTime = parseFloat(row.dataset.startTime);
                    const endTime = parseFloat(row.dataset.endTime);
                    const wasHighlighted = row.classList.contains('highlight-line');
                    const shouldHighlight = currentTime >= startTime && currentTime <= endTime;
                    
                    if (wasHighlighted !== shouldHighlight) {
                        if (shouldHighlight) {
                            row.classList.add('highlight-line');
                            activeRow = row;
                            currentRowIndex = index;
                        } else {
                            row.classList.remove('highlight-line');
                        }
                    }
                });

                if (activeRow && isScrollFollowing && lyricsVisible) {
                    // Use instant scroll on Fire TV to prevent shaking
                    const scrollBehavior = window.matchMedia('(pointer: coarse)').matches ? 'auto' : 'smooth';
                    activeRow.scrollIntoView({ behavior: scrollBehavior, block: 'center' });
                }
            }
            
            lyricRows.forEach(row => {
                row.addEventListener('click', () => {
                    video.currentTime = parseFloat(row.dataset.startTime);
                    if (video.paused) {
                        video.play();
                    }
                });
            });

            video.addEventListener('timeupdate', updateTime);
            video.addEventListener('play', updatePlayPauseIcon);
            video.addEventListener('pause', updatePlayPauseIcon);
            
            // Fire TV specific optimizations - throttle timeupdate for performance
            let lastTimeUpdate = 0;
            const originalTimeUpdate = updateTime;
            
            function throttledTimeUpdate() {
                const now = Date.now();
                if (now - lastTimeUpdate > 200) { // Only update every 200ms on Fire TV
                    lastTimeUpdate = now;
                    originalTimeUpdate();
                }
            }
            
            // Use throttled updates on Fire TV (detected by coarse pointer)
            if (window.matchMedia('(pointer: coarse)').matches) {
                video.removeEventListener('timeupdate', updateTime);
                video.addEventListener('timeupdate', throttledTimeUpdate);
            }
            
            // Fire TV specific video handling
            video.addEventListener('loadstart', () => {
                console.log('Video loading started');
            });
            video.addEventListener('error', (e) => {
                console.log('Video error:', e);
            });
            video.addEventListener('stalled', () => {
                console.log('Video stalled');
            });

            // Main controls event listeners
            playPauseBtn.addEventListener('click', togglePlayPause);
            playPauseBtn.addEventListener('keydown', (e) => {
                if (e.code === 'Enter' || e.code === 'Space') {
                    e.preventDefault();
                    togglePlayPause();
                }
            });
            
            loopBtn.addEventListener('click', () => {
                video.loop = !video.loop;
                loopBtn.classList.toggle('active', video.loop);
                loopBtnMini.classList.toggle('active', video.loop);
            });
            loopBtn.addEventListener('keydown', (e) => {
                if (e.code === 'Enter' || e.code === 'Space') {
                    e.preventDefault();
                    video.loop = !video.loop;
                    loopBtn.classList.toggle('active', video.loop);
                    loopBtnMini.classList.toggle('active', video.loop);
                }
            });
            
            muteBtn.addEventListener('click', () => {
                video.muted = !video.muted;
                updateMuteIcon();
            });
            muteBtn.addEventListener('keydown', (e) => {
                if (e.code === 'Enter' || e.code === 'Space') {
                    e.preventDefault();
                    video.muted = !video.muted;
                    updateMuteIcon();
                }
            });
            
            scrollLockBtn.addEventListener('click', () => {
                isScrollFollowing = !isScrollFollowing;
                updateScrollLockIcon();
            });
            scrollLockBtn.addEventListener('keydown', (e) => {
                if (e.code === 'Enter' || e.code === 'Space') {
                    e.preventDefault();
                    isScrollFollowing = !isScrollFollowing;
                    updateScrollLockIcon();
                }
            });
            
            lyricsToggleBtn.addEventListener('click', toggleLyrics);
            lyricsToggleBtn.addEventListener('keydown', (e) => {
                if (e.code === 'Enter' || e.code === 'Space') {
                    e.preventDefault();
                    toggleLyrics();
                }
            });

            // Mini controls event listeners (same functionality)
            playPauseBtnMini.addEventListener('click', togglePlayPause);
            playPauseBtnMini.addEventListener('keydown', (e) => {
                if (e.code === 'Enter' || e.code === 'Space') {
                    e.preventDefault();
                    togglePlayPause();
                }
            });
            
            loopBtnMini.addEventListener('click', () => {
                video.loop = !video.loop;
                loopBtn.classList.toggle('active', video.loop);
                loopBtnMini.classList.toggle('active', video.loop);
            });
            loopBtnMini.addEventListener('keydown', (e) => {
                if (e.code === 'Enter' || e.code === 'Space') {
                    e.preventDefault();
                    video.loop = !video.loop;
                    loopBtn.classList.toggle('active', video.loop);
                    loopBtnMini.classList.toggle('active', video.loop);
                }
            });
            
            muteBtnMini.addEventListener('click', () => {
                video.muted = !video.muted;
                updateMuteIcon();
            });
            muteBtnMini.addEventListener('keydown', (e) => {
                if (e.code === 'Enter' || e.code === 'Space') {
                    e.preventDefault();
                    video.muted = !video.muted;
                    updateMuteIcon();
                }
            });
            
            scrollLockBtnMini.addEventListener('click', () => {
                isScrollFollowing = !isScrollFollowing;
                updateScrollLockIcon();
            });
            scrollLockBtnMini.addEventListener('keydown', (e) => {
                if (e.code === 'Enter' || e.code === 'Space') {
                    e.preventDefault();
                    isScrollFollowing = !isScrollFollowing;
                    updateScrollLockIcon();
                }
            });
            
            lyricsToggleBtnMini.addEventListener('click', toggleLyrics);
            lyricsToggleBtnMini.addEventListener('keydown', (e) => {
                if (e.code === 'Enter' || e.code === 'Space') {
                    e.preventDefault();
                    toggleLyrics();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.code === 'Space' || event.code === 'Enter' || event.code === 'NumpadEnter') {
                    event.preventDefault();
                    togglePlayPause();
                } else if (event.code === 'ArrowRight') {
                    event.preventDefault();
                    let newIndex = (currentRowIndex < lyricRows.length - 1) ? currentRowIndex + 1 : lyricRows.length - 1;
                    if (newIndex !== currentRowIndex) {
                        currentRowIndex = newIndex;
                        const targetRow = lyricRows[currentRowIndex];
                        video.currentTime = parseFloat(targetRow.dataset.startTime);
                    }
                } else if (event.code === 'ArrowLeft') {
                    event.preventDefault();
                    let newIndex = (currentRowIndex > 0) ? currentRowIndex - 1 : 0;
                    if (newIndex !== currentRowIndex) {
                        currentRowIndex = newIndex;
                        const targetRow = lyricRows[currentRowIndex];
                        video.currentTime = parseFloat(targetRow.dataset.startTime);
                    }
                } else if (event.code === 'ArrowUp') {
                    event.preventDefault();
                    video.muted = !video.muted;
                    updateMuteIcon();
                } else if (event.code === 'ArrowDown') {
                    event.preventDefault();
                    video.loop = !video.loop;
                    loopBtn.classList.toggle('active', video.loop);
                    loopBtnMini.classList.toggle('active', video.loop);
                } else if (event.code === 'KeyL') {
                    event.preventDefault();
                    toggleLyrics();
                } else if (event.code === 'KeyS') {
                    event.preventDefault();
                    isScrollFollowing = !isScrollFollowing;
                    updateScrollLockIcon();
                }
            });

            video.muted = true;
            updatePlayPauseIcon();
            updateMuteIcon();
            updateScrollLockIcon();
            updateLyricsToggleIcon();
            loopBtn.innerHTML = icons.loop;
            loopBtnMini.innerHTML = icons.loop;
            
            function showTooltip(wordSpan) {
                if (currentTooltipElement) hideTooltip();
                const meaning = wordSpan.dataset.meaning, grammar = wordSpan.dataset.grammar, kana = wordSpan.dataset.kana, romaji = wordSpan.dataset.romaji, kanji = wordSpan.dataset.kanji, lyricNote = wordSpan.dataset.lyricNote;
                let h4Text = kanji ? `<span class="kanji-color">${kanji}</span>` : wordSpan.textContent.trim();
                const newTooltipElement = document.createElement('div');
                newTooltipElement.classList.add('tooltip-box');
                let content = `<h4>${h4Text}</h4>`;
                if (kana || romaji) {
                    content += `<div class="kana-romaji">`;
                    if (kanji && kana) content += `<p class="kana-display">${kana}</p>`;
                    if (romaji) content += `<p>${romaji}</p>`;
                    content += `</div>`;
                }
                if (meaning) content += `<p><strong>Meaning:</strong> ${meaning}</p>`;
                if (grammar) content += `<p><strong>Grammar:</strong> ${grammar}</p>`;
                if (lyricNote) content += `<p class="lyric-note">${lyricNote}</p>`;
                newTooltipElement.innerHTML = content;
                document.body.appendChild(newTooltipElement);
                currentTooltipElement = newTooltipElement;
                const rect = wordSpan.getBoundingClientRect();
                let left = rect.left + (rect.width / 2) - (currentTooltipElement.offsetWidth / 2);
                let top = rect.top - currentTooltipElement.offsetHeight - 10;
                if (left < 10) left = 10;
                if (left + currentTooltipElement.offsetWidth > window.innerWidth - 10) left = window.innerWidth - currentTooltipElement.offsetWidth - 10;
                if (top < 10) top = rect.bottom + 10;
                currentTooltipElement.style.left = `${left + window.scrollX}px`;
                currentTooltipElement.style.top = `${top + window.scrollY}px`;
                currentTooltipElement.style.opacity = '1';
                currentTooltipElement.style.visibility = 'visible';
            }

            function hideTooltip() {
                if (currentTooltipElement) {
                    currentTooltipElement.remove();
                    currentTooltipElement = null;
                }
            }

            function addHighlight(groupId, showTip) {
                document.querySelectorAll(`[data-group-id="${groupId}"]`).forEach(el => {
                    el.classList.add(el.classList.contains('word-group') ? 'highlight-jp-group' : 'highlight-en-phrase');
                });
                if (showTip) {
                    const wordGroup = document.querySelector(`.word-group[data-group-id="${groupId}"]`);
                    const firstTooltip = wordGroup ? wordGroup.querySelector('.word-tooltip') : null;
                    if (firstTooltip) {
                        showTooltip(firstTooltip);
                    }
                }
            }

            function removeHighlight(groupId) {
                document.querySelectorAll(`[data-group-id="${groupId}"]`).forEach(el => {
                    el.classList.remove('highlight-jp-group', 'highlight-en-phrase');
                });
                hideTooltip();
            }

            document.querySelectorAll('.word-group').forEach(group => {
                group.addEventListener('mouseenter', () => addHighlight(group.dataset.groupId, false));
                group.addEventListener('mouseleave', () => removeHighlight(group.dataset.groupId));
            });

            document.querySelectorAll('.translation-phrase').forEach(phrase => {
                phrase.addEventListener('mouseenter', () => addHighlight(phrase.dataset.groupId, true));
                phrase.addEventListener('mouseleave', () => removeHighlight(phrase.dataset.groupId));
            });

            tooltips.forEach(wordSpan => {
                wordSpan.addEventListener('mouseenter', () => showTooltip(wordSpan));
                wordSpan.addEventListener('mouseleave', () => hideTooltip());
            });
        });
    </script>
</body>
</html>